import { expect } from 'chai';
import { toJSON, fromJSON, addDataType } from '../src';
function fullCycle(obj, options) {
    return fromJSON(JSON.parse(JSON.stringify(toJSON(obj, options))));
}
function produceError() {
    return new Error('message');
}
describe('javascript-serializer', function () {
    it('should serialize errors', function () {
        var error = fullCycle(new Error('message'));
        expect(error).to.be.instanceof(Error);
        expect(error.toString()).to.eql('Error: message');
        expect(typeof error.stack).to.eql('string');
    });
    it('should contain the original stack trace', function () {
        var error = fullCycle(produceError());
        expect(error.stack).to.contain('produceError');
    });
    it('should not contain the original stack trace', function () {
        var error = fullCycle(produceError(), { stack: false });
        expect(error.stack).to.not.contain('produceError');
    });
    it('should serialize objects', function () {
        var data = {
            a: 1,
            b: 'str',
            c: { d: 2, e: 'str', f: [{ g: 3 }, { e: null }] },
        };
        expect(fullCycle(data)).to.eql(data);
    });
    it('should serialize objects that deeply contain an error', function () {
        var error = fullCycle({ error: new Error('message') }).error;
        expect(error).to.be.instanceof(Error);
    });
    it('should serialize dates', function () {
        var utc = Date.UTC(1981, 12, 27, 1, 2, 3, 4);
        var date = fullCycle(new Date(utc));
        expect(date).to.be.instanceof(Date);
        expect(date.getTime()).to.eql(utc);
    });
    it('should serialize regexp', function () {
        var regexp = /abc/gi;
        expect(regexp.exec('_ABC_')).to.eql(['ABC']); //lastIndex 0 => 4
        regexp = fullCycle(regexp);
        expect(regexp.exec('_ABC_')).to.eql(null); //lastIndex 4 => 0
        expect(regexp.exec('_ABC_')).to.eql(['ABC']); //lastIndex 0 => 4
    });
    it('should allow adding custom data types', function () {
        var Person = /** @class */ (function () {
            function Person(firstName, lastName) {
                var _this = this;
                this.firstName = firstName;
                this.lastName = lastName;
                this.fullName = function () { return _this.firstName + " " + _this.lastName; };
                this.toJSON = function () { return ({ firstName: _this.firstName, lastName: _this.lastName }); };
            }
            Person.fromJSON = function (_a) {
                var firstName = _a.firstName, lastName = _a.lastName;
                return new Person(firstName, lastName);
            };
            return Person;
        }());
        var aPerson = new Person('Shahar', 'Talmi');
        addDataType(Person);
        expect(fullCycle(aPerson).fullName()).to.eql('Shahar Talmi');
    });
    it('should allow adding custom serializable data types', function () {
        var Person = /** @class */ (function () {
            function Person(firstName, lastName) {
                var _this = this;
                this.firstName = firstName;
                this.lastName = lastName;
                this.fullName = function () { return _this.firstName + " " + _this.lastName; };
            }
            return Person;
        }());
        var SerializablePerson = /** @class */ (function () {
            function SerializablePerson(person) {
                var _this = this;
                this.person = person;
                this.toJSON = function () { return ({
                    firstName: _this.person.firstName,
                    lastName: _this.person.lastName,
                }); };
            }
            SerializablePerson.fromJSON = function (_a) {
                var firstName = _a.firstName, lastName = _a.lastName;
                return new Person(firstName, lastName);
            };
            return SerializablePerson;
        }());
        var aPerson = new Person('Shahar', 'Talmi');
        addDataType(SerializablePerson, Person);
        expect(fullCycle(aPerson).fullName()).to.eql('Shahar Talmi');
    });
    it('should serialize circular references', function () {
        var data = {
            a: 1,
            b: 'str',
            c: { d: 2, e: 'str', f: null },
            g: { h: 3 },
            i: [],
        };
        data.c.f = data.c;
        data.i.push(data.g);
        data.i.push(data.c);
        expect(fullCycle(data)).to.eql(data);
    });
});
//# sourceMappingURL=index.spec.js.map